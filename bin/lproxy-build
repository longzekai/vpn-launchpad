#!/bin/bash

DIR=`dirname $0`
VLPHOME="$(cd $DIR; cd ..; pwd)"
SSLLDIR="$VLPHOME/proxy-ssllibev"

VLPQUERY="$VLPHOME/vlp status"

echo "Checking VPS status..."
RESULT="/tmp/RESULT"
$VLPQUERY|tee $RESULT

VPSIP=`cat $RESULT|grep "VPN-SERVER:"|awk '{print $2}'|tr -d '\r\n'`
INSTID=`cat $RESULT|grep "VPN-SERVER:"|awk '{print $3}'|tr -d '\r\n'`
case $VPSIP in
	""|"None")
		echo "VPS not found."
		exit 0
		;;
	*)
		;;
esac

echo "Setting up local proxy daemon..."
cat $RESULT|grep $INSTID|grep "server-ssslibev\."|sed 's/server-ssslibev.//g'|sed 's/|//g'|awk '{print $1"="$3}'>$SSLLDIR/server-ssslibev.env
cp -a $SSLLDIR/proxy-ssllibev.env $SSLLDIR/proxy-ssllibev.env.out
sed -i.bak "s/SSHOST=.*/SSHOST=$VPSIP/g" $SSLLDIR/proxy-ssllibev.env.out
rm -rf $SSLLDIR/proxy-ssllibev.env.out.bak
echo "Done."
echo

$SSLLDIR/proxy-ssllibev.sh $*
echo "Wait 15s for local proxy initialisation..."
sleep 15
echo "Done."
echo

$VLPHOME/bin/lproxy-status
