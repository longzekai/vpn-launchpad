#!/bin/bash

DIR=`dirname $0`
VLPHOME="$(cd $DIR; pwd)"
. $VLPHOME/vlp.env
VLPCFG="$VLPHOME/.vpn-launchpad"
VLPKEY="$VLPCFG/$STACKID-key.pem"
VLPDKDIR="$VLPHOME/vpnlaunchpad"

ARCH=`uname -m`
DKUID=`id -u`
DKGID=`id -g`
IMGNAME="samuelhbne/vpnlaunchpad"

DKVER=`docker -v 2>/dev/null|awk '{print $3}'`
if [ "$DKVER" = "" ]; then
	echo "Docker executable not found.."
	echo "Abort."
	exit 255
fi

BUILD=1

if [ "$BUILD" = "1" ]; then
	case $ARCH in
		armv6l|armv7l)
			TARGET=arm
			;;
		x86_64|i686|i386)
			TARGET=amd64
			;;
		*)
			echo "Unsupported arch"
			exit
			;;
	esac
	cp -a $VLPDKDIR/Dockerfile.$TARGET $VLPDKDIR/Dockerfile
	sed -i.bak "s/^ENV DKUID .*/ENV DKUID ${DKUID}/" $VLPDKDIR/Dockerfile && rm -rf $VLPDKDIR/Dockerfile.bak
	sed -i.bak "s/^ENV DKGID .*/ENV DKGID ${DKGID}/" $VLPDKDIR/Dockerfile && rm -rf $VLPDKDIR/Dockerfile.bak
	echo "Building vpnlaunchpad image..."
	docker build --rm=true -t $IMGNAME:$TARGET.$DKUID.$DKGID $VLPDKDIR/
	echo
fi

mkdir -p $VLPHOME/.vpn-launchpad $VLPHOME/.aws
BPROFILE=`grep "\[profile $PROFILE\]" $VLPHOME/.aws/config 2>/dev/null`
if [ "$BPROFILE" = "" ]; then
        echo -e "[profile $PROFILE]\nregion = ap-northeast-1\noutput = json">>$VLPHOME/.aws/config
fi

DOCKERCMD="docker run --user $DKUID:$DKGID --rm=true -v $VLPHOME:/home/vlp -it $IMGNAME:$TARGET.$DKUID.$DKGID"

if [[ $# = 0 ]]; then
	$DOCKERCMD /home/vlp/bin/vlp-menu
else
	subcmd="$1"
	case $subcmd in
		init)
			shift
			$DOCKERCMD bash -c "while read -r -t 0; do read -r; done; /usr/bin/aws --profile $PROFILE configure"
			;;
		build)
			shift
			$DOCKERCMD bash -c "/home/vlp/bin/vlp-random; /home/vlp/bin/vlp-build; /home/vlp/bin/vlp-status --all"
			;;
		status)
			shift
			$DOCKERCMD /home/vlp/bin/vlp-status "$@"
			;;
		purge)
			shift
			$DOCKERCMD /home/vlp/bin/vlp-purge
			;;
		random)
			shift
			$DOCKERCMD /home/vlp/bin/vlp-random
			;;
		ssh)
			shift
			if [ -f $VLPKEY ]; then
				echo "Found private key: $VLPKEY"
				$DOCKERCMD /home/vlp/bin/vlp-ssh "$@"
			else
				echo "Missing private key: $VLPKEY"
				echo "Not created from this box?"
				echo "Abort."
				exit
			fi
			;;
		*)
			shift
			$DOCKERCMD /home/vlp/bin/vlp-menu
			;;
	esac
fi
